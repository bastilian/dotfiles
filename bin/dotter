#!/bin/bash
#
# dotter - OS X dotfile manager
#
# - Packages file
#
# The `Packages` file in the root of a `dotfile` directory will be sourced on `install`.
# It defines dependencies such as system packages, rubygems or npm packages.
#
# Example:
# ```
# pkg "node"        # Defines a system package. expands `brew install`
# pkg "rbenv"
# setruby 2.2.3     # Sets the global ruby to the specified version via `rbenv`
# envgem "bundler"  # expands to `gem install bundler`
# envnpm "grunt"    # expands to `npm install -g grunt`
# ```
#

export REPO_REG="\/(.*)\."
export DOTFILES="${DOTFILES:=$HOME/.dotfiles}"

cd "$DOTFILES"
source "$DOTFILES/lib/packages"

#
# `dotter link`
#
# Links directories in `$DOTFILES/dots` in $HOME as dotfiles
#
link-dots() {

  echo "Linking dotfiles from $HOME/.dotfiles"

  for dot in $HOME/.dotfiles/dots/* ; do
    echo "Linking $dot"

    local target="$HOME/.$(basename "$dot")"

    rm -fd "$target"
    ln -s "$dot" $target
  done

}

if [ "$1" = "link" ]; then
  link-dots
fi

#
# `dotter install-packages <dotfile-directory>`
#
# Installs packages defined in `Packages` for the dotfiles and links included dotfiles and directories from $HOME
#
install-packages() {
  echo "Installing $1/Packages"

  if [ -e "$1/Packages" ]; then
    source "$1/Packages"
  fi
}

if [ "$1" = "install-packages" ]; then
  install-packages "$DOTFILES/dots/$2"
fi

#
# `dotter install [git-repository]`
#
# Installs default packages defined in `Packages` for the dotfiles and links included dotfiles and directories from $HOME
#
install() {
  install-packages "$DOTFILES"
  link-dots
}

if [ "$1" = "install" ]; then
  install $@
fi

#
# Adds a given git repository url to the dots directory and installs Packages
#
add-repository() {
  if [[ "$1" =~ $REPO_REG ]]; then
    local name=${BASH_REMATCH[1]}

    git submodule add -f "$1" "dots/$name"
    git submodule update --init --recursive

    if [ -e "$DOTFILES/dots/$name/Packages" ]; then
      install-packages "$DOTFILES/dots/$name"
    fi

    ln -s  "$DOTFILES/dots/$name" "$HOME/.$name"

  fi
}

#
# Adds a given directory to the dots directory and installs Packages
#
add-directory() {
  local dot=$(basename "$1")
  local target="$DOTFILES/dots/${dot#.}"

  cp "$1" "$target"
  rm -r "$1"
  ln -s "$target" "$HOME/.$dot"

  if [ -e "$target/Packages" ]; then
    install-packages "$target"
  fi
}

#
# `dotter add <dotfile-name>`
#
# Adds a given dotfile or directory into `$DOTFILES/.dots` and links it.
#
add() {
  echo "Adding $1 to dotfiles"
  echo "$repo"

  if [[ "$1" =~ $REPO_REG ]]; then
    local name=${BASH_REMATCH[1]}
    echo $name
  fi

  if [[ "$1" =~ $REPO_REG ]]; then
    add-repository "$1"
  else
    add-directory "$1"
  fi

}

if [ "$1" = "add" ]; then
  add "$2"
fi

#
# `dotter list`
#
# Lists dots
#
list() {
  ls "$DOTFILES/dots"
}

if [ "$1" = "list" ]; then
  list
fi
